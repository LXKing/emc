<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.huak.home.dao.thiredpage.ThiredpageEnergyDao" >

    <sql id="between_and">
        BETWEEN
        <choose>
            <when test="startTime!=null and startTime!=''">
                #{startTime,jdbcType=VARCHAR}
            </when>
            <otherwise>
                SUBDATE(CURDATE(), INTERVAL 5 DAY)
            </otherwise>
        </choose>
        AND
        <choose>
            <when test="endTime!=null and endTime!=''">
                #{endTime,jdbcType=VARCHAR}
            </when>
            <otherwise>
                CURDATE()
            </otherwise>
        </choose>
    </sql>

    <!-- 能耗子页面，能耗曲线，能源流相关数据查询开始 -->
    <!-- 查询今年的集团能耗 -->
    <!-- 查询条件map内容：{orgId=38, feedType=2, startTime=2016-11-15, endTime=2017-06-15, orgType=} -->
    <sql id="cur_last_time">
        <choose>
            <when test="startTime!=null and startTime!=''">
                AND (DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
            </when>
            <otherwise>
                AND (DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[>=]]> SUBDATE(CURDATE(), INTERVAL 5 DAY)
            </otherwise>
        </choose>
        <choose>
            <when test="endTime!=null and endTime!=''">
                AND DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR})
            </when>
            <otherwise>
                AND DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[<=]]> CURDATE())
            </otherwise>
        </choose>
        <choose>
            <when test="startTime!=null and startTime!=''">
                OR (DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[>=]]> SUBDATE(#{startTime,jdbcType=VARCHAR}, INTERVAL 1 YEAR)
            </when>
            <otherwise>
                OR (DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[>=]]> SUBDATE(SUBDATE(CURDATE(), INTERVAL 5 DAY), INTERVAL 1 YEAR)
            </otherwise>
        </choose>
        <choose>
            <when test="endTime!=null and endTime!=''">
                AND DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[<=]]> SUBDATE(#{endTime,jdbcType=VARCHAR}, INTERVAL 1 YEAR))
            </when>
            <otherwise>
                AND DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') <![CDATA[<=]]> SUBDATE(CURDATE(), INTERVAL 1 YEAR))
            </otherwise>
        </choose>
    </sql>

   <!--三级页面-源、网、站、线、户的各个能源类型的能耗趋势图-->
    <select id="getDatas" resultType="java.util.Map" parameterType="java.util.Map">

        SELECT
        '0'as curyear,
        aa.time,
        max(case when aa.UNITTYPE = '1' then aa.DOSAGE else 0 end ) chart1,
        max(case when aa.UNITTYPE = '2' then aa.DOSAGE else 0 end ) chart2,
        max(case when aa.UNITTYPE = '3' then aa.DOSAGE else 0 end ) chart3,
        max(case when aa.UNITTYPE = '4' then aa.DOSAGE else 0 end ) chart4,
        max(case when aa.UNITTYPE = '5' then aa.DOSAGE else 0 end ) chart5 from
        (select b.UNITTYPE,DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d') time,SUM(a.DOSAGE) DOSAGE
        FROM
        t_emc_final_data_hour_tj  a ,
        (
            select v.UNITID,v.UNITTYPE,v.COMID from (select UNITID,UNITTYPE,COMID,ORGID FROM v_emc_unit WHERE 1=1
                <if test=" orgType != null and orgType != ''">
                    and  UNITTYPE =  #{orgType,jdbcType=VARCHAR}
                </if>
                <if test="feedType!= null and feedType != ''">
                    and  HEAT_TYPE =  #{feedType,jdbcType=VARCHAR}
                </if>
                <if test="comId != null and comId !=''">
                    and  COMID =#{comId}
                </if>
           ) v where  EXISTS(
                SELECT
                1
                FROM
                t_emc_org
                WHERE
                id = v.ORGID
                <if test="orgId != null and orgId !=''">
                   and  FIND_IN_SET(id,emc_func_org_getchilds (#{orgId,jdbcType=VARCHAR}))
                </if>
            )
        ) b,
        t_emc_energy_type c
        where
        a.UNITID = b.UNITID
        AND a.COMID = b.COMID
        and c.id = a.TYPEID
        <if test="startTime!=null and startTime!=''">
            and a.DOSAGE_TIME <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime!=null and endTime!=''">
            and a.DOSAGE_TIME <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR}
        </if>
        <if test="energytype != null and energytype !=''">
            and c.TYPE = #{energytype,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and a.COMID = #{comId,jdbcType=VARCHAR}
        </if>
        group by DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d'),b.UNITTYPE) aa GROUP BY aa.time
        union all
        (SELECT
        '1' as curyear,
        aa.time,
        max(case when aa.UNITTYPE = '1' then aa.DOSAGE else 0 end ) chart1,
        max(case when aa.UNITTYPE = '2' then aa.DOSAGE else 0 end ) chart2,
        max(case when aa.UNITTYPE = '3' then aa.DOSAGE else 0 end ) chart3,
        max(case when aa.UNITTYPE = '4' then aa.DOSAGE else 0 end ) chart4,
        max(case when aa.UNITTYPE = '5' then aa.DOSAGE else 0 end ) chart5 from
        (select b.UNITTYPE,DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d') time,SUM(a.DOSAGE) DOSAGE
        FROM
        t_emc_final_data_hour_tj  a ,
        (
        select v.UNITID,v.UNITTYPE,v.COMID from (select UNITID,UNITTYPE,COMID,ORGID FROM v_emc_unit WHERE 1=1
        <if test="orgType!= null and orgType != ''">
            and  UNITTYPE =  #{orgType,jdbcType=VARCHAR}
        </if>
        <if test="feedType!= null and feedType != ''">
            and  HEAT_TYPE =  #{feedType,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and  COMID =#{comId}
        </if>
        ) v where  EXISTS(
        SELECT
        1
        FROM
        t_emc_org
        WHERE
        id = v.ORGID
        <if test="orgId != null and orgId !=''">
            and  FIND_IN_SET(id,emc_func_org_getchilds (#{orgId,jdbcType=VARCHAR}))
        </if>
        )
        ) b,
        t_emc_energy_type c
        where
        a.UNITID = b.UNITID
        AND a.COMID = b.COMID
        and c.id = a.TYPEID
        <if test="startTimeTq!=null and startTimeTq!=''">
            and a.DOSAGE_TIME <![CDATA[>=]]> #{startTimeTq,jdbcType=VARCHAR}
        </if>
        <if test="endTimeTq!=null and endTimeTq!=''">
            and a.DOSAGE_TIME <![CDATA[<=]]> #{endTimeTq,jdbcType=VARCHAR}
        </if>
        <if test="energytype != null and energytype !=''">
            and c.TYPE = #{energytype,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and a.COMID = #{comId,jdbcType=VARCHAR}
        </if>
        group by DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d'),b.UNITTYPE) aa GROUP BY aa.time)

    </select>

    <!--三级页面-集团的各个能源类型的能耗趋势图-->
    <select id="getDatasAll" resultType="java.util.Map" parameterType="java.util.Map">

        SELECT
        '0'as curyear,
        aa.time,
       sum(aa.DOSAGE) num from
        (select b.UNITTYPE,DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d') time,SUM(a.DOSAGE) DOSAGE
        FROM
        t_emc_final_data_hour_tj  a ,
        (
        select v.UNITID,v.UNITTYPE,v.COMID from (select UNITID,UNITTYPE,COMID,ORGID FROM v_emc_unit WHERE 1=1
        <if test=" orgType != null and orgType != ''">
            and  UNITTYPE =  #{orgType,jdbcType=VARCHAR}
        </if>
        <if test="feedType!= null and feedType != ''">
            and  HEAT_TYPE =  #{feedType,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and  COMID =#{comId}
        </if>
        ) v where  EXISTS(
        SELECT
        1
        FROM
        t_emc_org
        WHERE
        id = v.ORGID
        <if test="orgId != null and orgId !=''">
            and  FIND_IN_SET(id,emc_func_org_getchilds (#{orgId,jdbcType=VARCHAR}))
        </if>
        )
        ) b,
        (select id,type from t_emc_energy_type where 1=1
        <if test="energytype != null and energytype !=''">
            and TYPE = #{energytype,jdbcType=VARCHAR}
        </if>
        ) c
        where
        a.UNITID = b.UNITID
        AND a.COMID = b.COMID
        and c.id = a.TYPEID
        <if test="startTime!=null and startTime!=''">
            and a.DOSAGE_TIME <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime!=null and endTime!=''">
            and a.DOSAGE_TIME <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR}
        </if>

        <if test="comId != null and comId !=''">
            and a.COMID = #{comId,jdbcType=VARCHAR}
        </if>
        group by DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d'),b.UNITTYPE) aa GROUP BY aa.time
        union all
        (SELECT
        '1' as curyear,
        aa.time,
        sum(aa.DOSAGE) num from
        (select b.UNITTYPE,DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d') time,SUM(a.DOSAGE) DOSAGE
        FROM
        t_emc_final_data_hour_tj  a ,
        (
        select v.UNITID,v.UNITTYPE,v.COMID from (select UNITID,UNITTYPE,COMID,ORGID FROM v_emc_unit WHERE 1=1
        <if test="orgType!= null and orgType != ''">
            and  UNITTYPE =  #{orgType,jdbcType=VARCHAR}
        </if>
        <if test="feedType!= null and feedType != ''">
            and  HEAT_TYPE =  #{feedType,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and  COMID =#{comId}
        </if>
        ) v where  EXISTS(
        SELECT
        1
        FROM
        t_emc_org
        WHERE
        id = v.ORGID
        <if test="orgId != null and orgId !=''">
            and  FIND_IN_SET(id,emc_func_org_getchilds (#{orgId,jdbcType=VARCHAR}))
        </if>
        )
        ) b,
        (select id,type from t_emc_energy_type WHERE 1=1
        <if test="energytype != null and energytype !=''">
            and TYPE = #{energytype,jdbcType=VARCHAR}
        </if>
        ) c
        where
        a.UNITID = b.UNITID
        AND a.COMID = b.COMID
        and c.id = a.TYPEID
        <if test="startTimeTq!=null and startTimeTq!=''">
            and a.DOSAGE_TIME <![CDATA[>=]]> #{startTimeTq,jdbcType=VARCHAR}
        </if>
        <if test="endTimeTq!=null and endTimeTq!=''">
            and a.DOSAGE_TIME <![CDATA[<=]]> #{endTimeTq,jdbcType=VARCHAR}
        </if>
        <if test="comId != null and comId !=''">
            and a.COMID = #{comId,jdbcType=VARCHAR}
        </if>
        group by DATE_FORMAT(a.DOSAGE_TIME,'%Y-%m-%d'),b.UNITTYPE) aa GROUP BY aa.time)

    </select>

     <select id="selectassessment" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT round(SUM(B.dosage),2) dosage, A.UNITID,A.unitname FROM (

         <if test="orgType!= null and orgId !='' and  orgType == 3">
         SELECT vu.UNITID,b.STATION_NAME as unitname FROM v_emc_unit vu,
         t_emc_unit_station b
         </if>
         <if test="orgType!= null and orgId !='' and  orgType == 1">
             SELECT vu.UNITID,b.FEED_NAME as unitname FROM v_emc_unit vu,
             t_emc_unit_feed b
         </if>
        WHERE 1 = 1 and vu.UNITID = b.ID
         <if test="orgId != null and orgId !=''">
             and   EXISTS (select id from t_emc_org where
             FIND_IN_SET(id,emc_func_org_getchilds(#{orgId})) and id = vu.ORGID)
         </if>
         <if test="feedType != null and feedType !=''">
             and  vu.HEAT_TYPE =#{feedType}
         </if>
         <if test="comId != null and comId !=''"> and  vu.COMID =#{comId} </if>
         <if test="orgType != null and orgType !=''">
             and  vu.UNITTYPE  = #{orgType}
         </if>
        GROUP BY vu.UNITID , <if test="orgType!= null and orgId !='' and  orgType == 3">b.STATION_NAME</if>
         <if test="orgType!= null and orgId !='' and  orgType == 1">b.FEED_NAME</if>) A,
        (
        SELECT h.UNITID AS unitid,sum(h.DOSAGE) dosage, et.type AS energytype,
        DATE_FORMAT(h.DOSAGE_TIME, '%Y-%m-%d') AS yeardate
        FROM  (select UNITID,DOSAGE,DOSAGE_TIME,TYPEID from ${tableName} where 1=1
             <if test="comId != null and comId !=''">
                 and  COMID =#{comId}
             </if>
             <if test="startTime!=null and startTime!=''">
                 and DOSAGE_TIME <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
             </if>
             <if test="endTime!=null and endTime!=''">
                 and DOSAGE_TIME <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR}
             </if>
         )h left join
         (select id,type from t_emc_energy_type where 1=1 <if test="energytype != null and energytype !=''"> and  type =#{energytype} </if>) et on h.TYPEID = et.id
        GROUP BY unitid, et.type, yeardate
        ) B where A.UNITID = B.unitid and B.energytype is not null
        GROUP BY A.UNITID order by SUM(B.dosage) DESC
     </select>

    <select id="getTables" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        d.UNITNAME as unitName,
        d.UNITTYPE as unitType,
        <foreach collection="currentYear" index="index" item="tag" open=""  separator="," close="">
            MAX((CASE d.DOSAGE_TIME WHEN #{tag} THEN d.DOSAGE ELSE 0 END)) c${index}
        </foreach>
        ,
        <foreach collection="lastYear" index="i" item="val" open=""  separator="," close="">
            MAX((CASE d.DOSAGE_TIME WHEN #{val} THEN d.DOSAGE ELSE 0 END)) l${i}
        </foreach>
        ,
        <foreach collection="currentYear" index="i" item="val" open=""  separator="," close="">
            0 p${i}
        </foreach>
        FROM (select a.unitid,a.unittype,a.unitname,m.DOSAGE as DOSAGE,m.DOSAGE_TIME as DOSAGE_TIME ,m.BM  FROM
        (select UNITID,UNITNAME,UNITTYPE from v_emc_unit where 1=1
        <if test="feedType != null and feedType !=''">
            and  HEAT_TYPE =#{feedType}
        </if>
        <if test="orgType != null and orgType!=''">UNITTYPE = #{orgType}</if>
        <if test="orgId != null and orgId !=''">
          and FIND_IN_SET(ORGID,emc_func_org_getchilds(#{orgId}))
        </if>
        )a left join
        ( SELECT fdh.UNITID,SUM(fdh.DOSAGE) DOSAGE,SUM(fdh.DOSAGE*fdh.COAL_COEF) BM,DATE_FORMAT(DOSAGE_TIME,'%Y-%m-%d') DOSAGE_TIME
        FROM t_emc_final_data_hour_tj fdh,t_emc_energy_type eet  WHERE 1=1
        <if test="comId != null and comId !=''">
            AND fdh.COMID= #{comId}
        </if>
        <if test="energytype != null and energytype !=''">
            and eet.TYPE = #{energytype,jdbcType=VARCHAR}
        </if>

        <if test="startTime!=null and startTime!=''">
            and fdh.DOSAGE_TIME <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime!=null and endTime!=''">
            and fdh.DOSAGE_TIME <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR}
        </if>
        and fdh.TYPEID = eet.ID
        GROUP BY fdh.UNITID,DATE_FORMAT(DOSAGE_TIME,'%Y-%m-%d')) m on a.unitid = m.unitid
        union all
        (select a.unitid,a.unittype,a.unitname,m.DOSAGE as DOSAGE,m.DOSAGE_TIME as DOSAGE_TIME ,m.BM  FROM
        (select UNITID,UNITNAME,UNITTYPE from v_emc_unit where 1=1
        <if test="feedType != null and feedType !=''">
            and  HEAT_TYPE =#{feedType}
        </if>
        <if test="orgType != null and orgType!=''">HEAT_TYPE = #{orgType}</if>
        <if test="orgId != null and orgId !=''">
            and FIND_IN_SET(ORGID,emc_func_org_getchilds(#{orgId}))
        </if>
        )a left join
        (SELECT fdh.UNITID,SUM(fdh.DOSAGE) DOSAGE,SUM(fdh.DOSAGE*fdh.COAL_COEF) BM,DATE_FORMAT(DOSAGE_TIME,'%Y-%m-%d')
        DOSAGE_TIME
        FROM t_emc_final_data_hour_tj fdh,t_emc_energy_type eet WHERE fdh.TYPEID = eet.ID
            <if test="comId != null and comId !=''">AND fdh.COMID= #{comId} </if>
            <if test="energytype != null and energytype !=''">and eet.TYPE = #{energytype,jdbcType=VARCHAR}</if>

            <if test="startTimeTq!=null and startTimeTq!=''">
                and fdh.DOSAGE_TIME <![CDATA[>=]]> #{startTimeTq,jdbcType=VARCHAR}
            </if>
            <if test="endTimeTq!=null and endTimeTq!=''">
                and fdh.DOSAGE_TIME <![CDATA[<=]]> #{endTimeTq,jdbcType=VARCHAR}
            </if>
            GROUP BY fdh.UNITID,DATE_FORMAT(DOSAGE_TIME,'%Y-%m-%d'))m on a.unitid = m.unitid
        )

        ) d   GROUP BY d.UNITID  order by d.UNITTYPE

    </select>

    <select id="getTotal" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        (CASE WHEN M.UNITTYPE = '1' THEN '源'
        WHEN M.UNITTYPE = '2' THEN '网'
        WHEN M.UNITTYPE = '3' THEN '站'
        WHEN M.UNITTYPE = '4' THEN '线'
        WHEN M.UNITTYPE = '5' THEN '户' else '' end) as unitName,
        M.UNITTYPE as unitType,
        <foreach collection="currentYear" index="index" item="tag" open=""  separator="," close="">
            MAX((CASE M.DOSAGE_TIME WHEN #{tag} THEN M.DOSAGE ELSE 0 END)) c${index}
        </foreach>
        ,
        <foreach collection="lastYear" index="i" item="val" open=""  separator="," close="">
            MAX((CASE M.DOSAGE_TIME WHEN #{val} THEN M.DOSAGE ELSE 0 END)) l${i}
        </foreach>
        ,
        <foreach collection="lastYear" index="i" item="val" open=""  separator="," close="">
            0 p${i}
        </foreach>
         FROM (SELECT
        ev.UNITTYPE,
        SUM(fdh.DOSAGE) DOSAGE,
        SUM(fdh.DOSAGE * fdh.COAL_COEF) BM,
        DATE_FORMAT(DOSAGE_TIME, '%Y-%m-%d') DOSAGE_TIME
        FROM
        t_emc_final_data_hour_tj   fdh,
        t_emc_energy_type eet,
        (select UNITID,UNITTYPE,COMID from v_emc_unit where 1=1
        <if test="orgId != null and orgId != ''">
            and EXISTS (select id from t_emc_org where
            FIND_IN_SET(id,emc_func_org_getchilds(#{orgId})) and id = ORGID)
        </if>
        ) ev
        WHERE
        fdh.TYPEID = eet.ID
        and fdh.UNITID = ev.UNITID
        and fdh.COMID = ev.COMID
        <if test="comId != null and comId !=''">
            AND fdh.COMID= #{comId}
        </if>
        <if test="energytype != null and energytype !=''">
            and eet.TYPE = #{energytype,jdbcType=VARCHAR}
        </if>

        <if test="startTime!=null and startTime!=''">
            and fdh.DOSAGE_TIME <![CDATA[>=]]> #{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime!=null and endTime!=''">
            and fdh.DOSAGE_TIME <![CDATA[<=]]> #{endTime,jdbcType=VARCHAR}
        </if>
        GROUP BY
        ev.UNITTYPE,
        DATE_FORMAT(DOSAGE_TIME, '%Y-%m-%d')

        UNION ALL
        (SELECT
        ev.UNITTYPE,
        SUM(fdh.DOSAGE) DOSAGE,
        SUM(fdh.DOSAGE * fdh.COAL_COEF) BM,
        DATE_FORMAT(DOSAGE_TIME, '%Y-%m-%d') DOSAGE_TIME
        FROM
        t_emc_final_data_hour_tj   fdh,
        t_emc_energy_type eet,
        (select UNITID,UNITTYPE,COMID from v_emc_unit where 1=1
        <if test="orgId != null and orgId != ''">
            and EXISTS (select id from t_emc_org where
            FIND_IN_SET(id,emc_func_org_getchilds(#{orgId})) and id = ORGID)
        </if>
         ) ev
        WHERE
        fdh.TYPEID = eet.ID
        and fdh.UNITID = ev.UNITID
        and fdh.COMID = ev.COMID
        <if test="comId != null and comId !=''">
            AND fdh.COMID= #{comId}
        </if>
        <if test="energytype != null and energytype !=''">
            and eet.TYPE = #{energytype,jdbcType=VARCHAR}
        </if>

        <if test="startTimeTq!=null and startTimeTq!=''">
            and fdh.DOSAGE_TIME <![CDATA[>=]]> #{startTimeTq,jdbcType=VARCHAR}
        </if>
        <if test="endTimeTq!=null and endTimeTq!=''">
            and fdh.DOSAGE_TIME <![CDATA[<=]]> #{endTimeTq,jdbcType=VARCHAR}
        </if>
        GROUP BY
        ev.UNITTYPE,
        DATE_FORMAT(DOSAGE_TIME, '%Y-%m-%d')))M

        group by M.UNITTYPE

    </select>
</mapper>